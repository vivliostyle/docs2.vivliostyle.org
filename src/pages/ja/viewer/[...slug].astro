---
/**
 * Vivliostyle.js ドキュメントページ（日本語版）
 * 動的ルーティング: /ja/viewer/* にマッチ
 */
import DocsLayout from '../../../layouts/DocsLayout.astro';
import LanguageSwitcher from '../../../components/LanguageSwitcher.astro';
import PageNavigation from '../../../components/PageNavigation.astro';
import TableOfContents from '../../../components/TableOfContents.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const viewerDocs = await getCollection('vivliostyle-viewer-ja');
  const viewerDocsEn = await getCollection('vivliostyle-viewer-en');
  
  // 英語版に存在するIDのセットを作成
  const enIds = new Set(viewerDocsEn.map(d => d.id));

  return viewerDocs.map(doc => {
    // [...slug]パターンでは文字列でslugを渡す
    // README.mdは日本語版には存在しないため、それぞれのファイル名で処理
    const slug = doc.id;

    return {
      params: { slug },
      props: { 
        doc, 
        viewerDocs,
        hasEnTranslation: enIds.has(doc.id)
      },
    };
  });
}

const { doc, viewerDocs, hasEnTranslation } = Astro.props;
const htmlContent = doc.rendered?.html || '';
const title = doc.data?.title || 'Vivliostyle.js ドキュメント';
const description = doc.data?.description || '';
const extractedToc = doc.data?.extractedToc; // 抽出したTOC（存在する場合）

// 見出しから目次を生成
const headings = doc.data?.headings || [];

// 目次に表示するのは h2 から h3 まで（有効なslugを持つもののみ）
const tocHeadings = (headings || []).filter(h => h && h.slug && h.depth >= 2 && h.depth <= 3);

// ページの順序を定義
const pageOrder = [
  'vivliostyle-viewer',
  'supported-css-features',
  'api',
  'contribution-guide',
];

const sortedDocs = [...viewerDocs].sort((a, b) => {
  const indexA = pageOrder.indexOf(a.id);
  const indexB = pageOrder.indexOf(b.id);
  // pageOrderにないものは最後に配置
  if (indexA === -1 && indexB === -1) return a.id.localeCompare(b.id);
  if (indexA === -1) return 1;
  if (indexB === -1) return -1;
  return indexA - indexB;
});

// 現在のページのインデックスを取得
const currentIndex = sortedDocs.findIndex(d => d.id === doc.id);
const prevPage = currentIndex > 0 ? sortedDocs[currentIndex - 1] : null;
const nextPage = currentIndex < sortedDocs.length - 1 ? sortedDocs[currentIndex + 1] : null;
---

<DocsLayout 
  title={title} 
  description={description}
  lang="ja"
  section="viewer"
>
  <!-- ヘッダーに言語切り替え -->
  {hasEnTranslation && (
    <div slot="header" class="language-switcher-container">
      <LanguageSwitcher 
        currentLang="ja" 
        pagePath={`/viewer/${doc.id}`}
        hasTranslation={hasEnTranslation}
      />
    </div>
  )}

  <!-- サイドバーにナビゲーションと目次を表示 -->
  <nav slot="sidebar">
    <h3>Vivliostyle Viewer ドキュメント</h3>
    <a href="/ja/" class="back-to-home">← ホームに戻る</a>
    {doc.id === 'vivliostyle-viewer' ? (
      <>
        <div class="toc-headings">
          {headings.filter(h => h.depth === 2 || h.depth === 3).map((heading, index, arr) => {
            if (heading.depth !== 2) return null;
            
            const nextH2Index = arr.findIndex((h, i) => i > index && h.depth === 2);
            const h3List = headings
              .slice(index + 1, nextH2Index === -1 ? headings.length : arr.findIndex((h, i) => i > index && h.depth === 2))
              .filter(h => h.depth === 3);
            
            // HTMLタグを除去してプレーンテキストのみを取得
            const getPlainText = (html: string) => {
              return html.replace(/<[^>]*>/g, '');
            };
            
            return (
              <li class="toc-h2">
                {h3List.length > 0 ? (
                  <button class="toc-toggle" data-target={`toc-group-${index}`} aria-expanded="false">
                    <span class="toggle-icon">▶</span><a href={`#${heading.slug}`}>{getPlainText(heading.text)}</a>
                  </button>
                ) : (
                  <a href={`#${heading.slug}`} class="toc-h2-link">{getPlainText(heading.text)}</a>
                )}
                {h3List.length > 0 && (
                  <ul class="toc-h3-list" id={`toc-group-${index}`} style="display: none;">
                    {h3List.map(h3 => (
                      <li class="toc-h3">
                        <a href={`#${h3.slug}`}>{getPlainText(h3.text)}</a>
                      </li>
                    ))}
                  </ul>
                )}
              </li>
            );
          })}
        </div>
      </>
    ) : (
      tocHeadings.length > 0 && (
        <ul class="toc-list" style="list-style: none; padding-left: 0;">
          {tocHeadings.map((heading) => {
            const slug = heading.slug || '';
            const text = heading.text || '';
            // HTMLタグを除去してプレーンテキストのみを取得
            const plainText = text.replace(/<[^>]*>/g, '');
            return (
              <li class={`toc-item toc-level-${heading.depth}`}>
                <a href={`#${slug}`}>{plainText}</a>
              </li>
            );
          })}
        </ul>
      )
    )}
  </nav>

  <!-- メインコンテンツ -->
  <article class="docs-content">
    <!-- 抽出したTOCが存在する場合は表示 -->
    {extractedToc && (
      <div class="toc" set:html={extractedToc}></div>
    )}
    
    <div set:html={htmlContent}></div>
  </article>

  <!-- ページナビゲーション -->
  <PageNavigation
    prevPage={prevPage}
    nextPage={nextPage}
    basePath="/ja/viewer"
    prevLabel="← 前へ"
    nextLabel="次へ →"
  />
</DocsLayout>

<style>
  .docs-content {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .docs-content h1 {
    margin-bottom: 1.5rem;
  }

  .toc {
    background: var(--color-bg-secondary, #f5f5f5);
    padding: 1rem;
    border-radius: 8px;
    margin: 1.5rem 0;
  }

  .toc :global(ul) {
    list-style: none;
    padding-left: 1rem;
  }

  .toc :global(li) {
    margin: 0.5rem 0;
  }

  .toc :global(a) {
    color: var(--color-text-primary, #333);
    text-decoration: none;
  }

  .toc :global(a:hover) {
    text-decoration: underline;
  }

  /* アコーディオンメニュースタイル */
  .toc-headings {
    list-style: none;
    padding: 0;
    margin: 1rem 0;
  }

  .toc-h2 {
    margin: 0.5rem 0;
  }

  .toc-toggle {
    display: flex;
    align-items: flex-start;
    width: 100%;
    background: none;
    border: none;
    padding: 0;
    text-align: left;
    cursor: pointer;
    gap: 0;
  }

  .toggle-icon {
    display: inline-block;
    transition: transform 0.2s;
    font-size: 0.7rem;
    padding-top: 0.2rem;
  }

  .toc-toggle[aria-expanded="true"] .toggle-icon {
    transform: rotate(90deg);
  }

  .toc-toggle a {
    color: var(--color-text);
    text-decoration: none;
  }

  .toc-toggle a:hover {
    color: var(--color-primary);
  }

  .toc-h2-link {
    color: var(--color-text);
    text-decoration: none;
    display: block;
    padding: 0.25rem 0;
  }

  .toc-h2-link:hover {
    color: var(--color-primary);
  }

  .toc-h3-list {
    list-style: none;
    padding-left: 1rem;
    margin: 0.25rem 0 0 0;
  }

  .toc-h3 {
    margin: 0.25rem 0;
  }

  .toc-h3 a {
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: 1rem;
  }

  .toc-h3 a:hover {
    color: var(--color-primary);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggleButtons = document.querySelectorAll('.toc-toggle');
    
    toggleButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        // リンククリックの場合は通常の動作を許可
        if (e.target.tagName === 'A') {
          return;
        }
        
        e.preventDefault();
        const targetId = button.getAttribute('data-target');
        const targetList = document.getElementById(targetId);
        const isExpanded = button.getAttribute('aria-expanded') === 'true';
        
        button.setAttribute('aria-expanded', !isExpanded);
        if (targetList) {
          targetList.style.display = isExpanded ? 'none' : 'block';
        }
      });
    });
  });
</script>
